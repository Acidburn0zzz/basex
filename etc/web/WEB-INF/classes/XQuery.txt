import java.io.*;
import javax.servlet.*;
import javax.servlet.http.*;
import org.basex.data.PrintSerializer;
import org.basex.data.Result;
import org.basex.io.CachedOutput;
import org.basex.io.IOConstants;
import org.basex.query.xquery.XQueryProcessor;
import org.basex.util.Token;

/** XQuery Servlet class. */
public class XQuery extends HttpServlet {
  /** Root directory (dynamic?...). */
  private static final String ROOT = "webapps/ROOT/";
  // "webapps" + request.getContextPath() + "/";

  /**
   * Creates the web page.
   * @param request servlet request
   * @param response servlet response
   */
  public void doGet(HttpServletRequest request, HttpServletResponse response)
      throws IOException, ServletException {

    response.setContentType("text/html");
    
    PrintWriter out = response.getWriter();
    String file = request.getParameter("page");
    if(file == null || file.length() == 0) file = "index";
    final String fn = ROOT + file + ".xq";
    final String query = Token.string(IOConstants.read(ROOT + file + ".xq"));

    try {
      // create query instance
      final XQueryProcessor xq = new XQueryProcessor(query, new File(fn));
      final Result res = xq.query(null);
      final CachedOutput cache = new CachedOutput();
      res.serialize(new PrintSerializer(cache));
      out.print(cache.toString());
    } catch(final Exception e) {
      out.print(e.toString());
    }
  }

  /* assign parameters to the xquery processor
  for(final String[] arg : req.args) {
    final Var v = new Var(new QNm(Token.token(arg[0])));
    final String val = arg.length == 2 ? arg[1] : "";
    xq.ctx.vars.addGlobal(v.item(Str.get(Token.token(val))));
  }*/
}
